@page
@model DevBin.Pages.PasteModel
@using Humanizer
@{
    ViewData["Title"] = Model.Paste.Title ?? Model.Paste.Code;
    var paste = Model.Paste;

    var isAuthor = paste.AuthorId != null && HttpContext.User.Identity.IsAuthenticated && HttpContext.User.Identity.Name == paste.Author.Username;
}

<div class="row justify-content-between my-2">
    @if (paste.Author != null)
    {
        <h6 class="m-0">By <a class="text-light" href="/User/@paste.Author.Username">@paste.Author.Username</a></h6>

    }
    else
    {
        <h6 class="m-0">By Guest</h6>
    }

    <div class="col-md-8 col-sm-12">
        @if (paste.ExposureId == 4) // Encrypted
        {
            <i class="fas fa-lock d-inline"></i>
        }
        <h3 class="fs-4 d-inline">@paste.Title</h3>
        <div class="pt-2">
            <span class="badge bg-light text-dark d-inline">@paste.Syntax.Pretty</span>
            <span class="text-muted d-inline ms-2" title="Content size">@Model.Size</span>
            <span class="text-muted d-inline ms-2" title="Total views">
                <i class="fas fa-eye"></i> @paste.Views
            </span>
            <span class="text-muted d-inline ms-2" title="Creation date">
                <i class="fas fa-clock"></i> @paste.Datetime.Humanize()
            </span>
            @if (paste.UpdateDatetime.HasValue)
            {
                <span class="text-muted d-inline ms-2" title="Last update date">
                    <i class="fas fa-edit"></i> @paste.UpdateDatetime.Humanize()
                </span>
            }
        </div>
    </div>

    <div class="col-md-4 col-sm-12 my-1">
        <div class="row g-2">
            <div class="col-md-4 col-sm-12">
                @if (isAuthor)
                {
                    @if (paste.Exposure.AllowEdit)
                    {
                        <a href="/Edit/@paste.Code" role="button" type="submit" class="form-control btn btn-sm btn-outline-light mt"><i class="fas fa-edit"></i> Edit Paste</a>
                    }
                    else
                    {
                        <button class="form-control btn btn-sm btn-outline-light disabled" disabled><i class="fas fa-edit"></i> Edit Paste</button>
                    }

                    <a asp-page="Paste" asp-page-handler="Delete" asp-route-code="@paste.Code" role="button" type="submit" class="form-control btn btn-sm btn-outline-danger mt-2" onclick="return confirm('Are you sure you want to delete this paste?')"><i class="fas fa-trash-alt"></i> Delete Paste</a>

                }
            </div>
            <div class="col-md-4 col-sm-12">
                <a href="/raw/@paste.Code" role="button" class="form-control btn btn-sm btn-outline-light"><i class="fas fa-code"></i> Raw Paste</a>
                <a href="/?clone=@paste.Code" role="button" type="submit" class="form-control btn btn-sm btn-outline-light mt-2"><i class="fas fa-plus"></i> Clone Paste</a>
            </div>
            <div class="col-md-4 col-sm-12">
                <a asp-page-handler="Download" role="button" class="form-control btn btn-sm btn-outline-light"><i class="fa fa-download"></i> Download</a>
                <a asp-page="Report" asp-route-code="@paste.Code" role="button" class="form-control btn btn-sm btn-outline-danger mt-2"><i class="fas fa-exclamation-triangle"></i> Report</a>
            </div>
        </div>
    </div>

</div>
<div id="paste-content" class="my-2 form-control bg-dark text-light font-monospace codeblock outline-dark @(paste.ExposureId == 4 ? "locked" : "")">@paste.Content</div>
<div class="my-2">
    <textarea id="paste-copy" wrap="off" class="form-control bg-dark text-muted font-monospace codeblock btn-outline-secondary" style="overflow: scroll; white-space: pre;">@paste.Content</textarea>
</div>

<input id="paste-syntax" class="d-none" hidden value="@paste.Syntax.Name" />

@if (paste.Exposure.Id == 4)
{
    <input id="encrypted-data" type="hidden" asp-for="Paste.Content" />
    <div class="modal fade" id="unlock-modal" tabindex="-1" aria-labelledby="unlockLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark border-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="unlockLabel"><i class="fas fa-lock"></i> Encrypted Paste!</h5>
                    <button type="button" class="btn-close text-light" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This paste is encrypted and requires a key to be readable.</p>
                    <div class="row row-cols-lg-auto">
                        <div class="col-8">
                            <div class="input-group">
                                <div class="input-group-text">
                                    <i class="fas fa-key"></i>
                                </div>
                                <!-- this is ridiculous -->
                                <input id="paste-key" name="paste-key" type="password" autocomplete="off" class="form-control bg-dark text-light" placeholder="Paste key..."
                                       readonly onfocus="this.removeAttribute('readonly');" , onfocusout="this.setAttribute('readonly','readonly');" />
                            </div>
                        </div>

                        <div class="col-4">
                            <button type="button" class="btn btn-primary" onclick="decryptPaste();"><i class="fas fa-unlock"></i> Decrypt</button>
                        </div>
                    </div>
                    <span id="paste-key-validation" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>
}

@if (paste.Content.Split("\n").Length > 2048)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <div id="too-long-alert" class="toast show bg-dark border-light" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-dark text-warning">
                <strong class="me-auto">Slow performance</strong>
            </div>
            <div class="toast-body">
                <p>Line numbers are not processed because it may impact the page performance.</p>
                <button type="button" class="btn btn-warning btn-sm" onclick="displayLinesAnyway(this);">Display anyway</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="closeAlert();">Ignore</button>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/paste.js"></script>

    @if (paste.Exposure.Id == 4)
    {
        <script>
            let modal = new bootstrap.Modal(document.getElementById('unlock-modal'), {})

            function decryptPaste() {
                let pasteKey = document.getElementById("paste-key");
                let validation = document.getElementById("paste-key-validation");

                let pasteContent = document.getElementById("paste-content");
                let encryptedContent = document.getElementById("encrypted-data").value;
                let pasteCopy = document.getElementById("paste-copy");
                let content = CryptoJS.AES.decrypt(encryptedContent, pasteKey.value).toString(CryptoJS.enc.Utf8);
                if (content.length == 0 || !content) {
                    validation.innerText = "Incorrect password!"
                } else {
                    validation.innerText = "";
                    pasteCopy.innerText = content;
                    pasteContent.textContent = content;
                    pasteContent.classList.remove("locked");
                    pasteContent.classList.remove("text-muted");
                    modal.hide();
                }
            }

            modal.show();
        </script>
    }
}
